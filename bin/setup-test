#!/usr/bin/env bash
# Set up a test environment from the dotfiles devcontainer template

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

usage() {
  cat << EOF
Usage: $(basename "$0")

Set up a test environment from the dotfiles devcontainer template.

OPTIONS:
  -h, --help     Show this help message

EXAMPLES:
  # Set up the test environment
  $(basename "$0")

WORKFLOW:
  This script mimics the GitHub Actions smoke-test workflow:
  1. Copies template to tmp/
  2. Replaces template options with defaults
  3. Copies test files
  4. Creates and starts the devcontainer using @devcontainers/cli

After setup completes, use 'bin/run' to execute commands in the container.
EOF
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

TEMPLATE_ID="dotfiles"

SRC_DIR="$REPO_ROOT/tmp/${TEMPLATE_ID}"

echo "Setting up test environment: ${TEMPLATE_ID}"
echo "Source: $REPO_ROOT/src/${TEMPLATE_ID}"
echo "Test dir: ${SRC_DIR}"
echo

# Clean up any existing test environment
if [[ -d "${SRC_DIR}" ]]; then
  echo "Cleaning up existing test directory..."
  rm -rf "${SRC_DIR}"
fi

# Create tmp directory if it doesn't exist
mkdir -p "$REPO_ROOT/tmp"

# Copy template to temp directory
echo "Copying template files..."
shopt -s dotglob
cp -R "$REPO_ROOT/src/${TEMPLATE_ID}" "${SRC_DIR}"

cd "${SRC_DIR}"

# Configure templates only if `devcontainer-template.json` contains the `options` property.
echo "Processing template options..."
OPTION_PROPERTY=$(jq -r '.options' devcontainer-template.json)

if [[ "${OPTION_PROPERTY}" != "" && "${OPTION_PROPERTY}" != "null" ]]; then
    OPTIONS=$(jq -r '.options | keys[]' devcontainer-template.json)

    if [[ "${OPTIONS}" != "" && "${OPTIONS}" != "null" ]]; then
        echo "Configuring template options for '${TEMPLATE_ID}'"
        while IFS= read -r OPTION; do
            OPTION_KEY="\${templateOption:$OPTION}"
            OPTION_VALUE=$(jq -r ".options.${OPTION}.default" devcontainer-template.json)

            if [[ "${OPTION_VALUE}" == "" || "${OPTION_VALUE}" == "null" ]]; then
                echo "Error: Template '${TEMPLATE_ID}' is missing a default value for option '${OPTION}'" >&2
                exit 1
            fi

            echo "  Replacing '${OPTION_KEY}' with '${OPTION_VALUE}'"
            OPTION_VALUE_ESCAPED=$(sed -e 's/[]\/$*.^[]/\\&/g' <<<"${OPTION_VALUE}")
            find ./ -type f -print0 | xargs -0 sed -i '' "s/${OPTION_KEY}/${OPTION_VALUE_ESCAPED}/g"
        done <<< "$OPTIONS"
    fi
fi

# Copy test files if they exist
TEST_DIR="$REPO_ROOT/test/${TEMPLATE_ID}"
if [[ -d "${TEST_DIR}" ]]; then
    echo "Copying test files..."
    DEST_DIR="${SRC_DIR}/test-project"
    mkdir -p "${DEST_DIR}"
    cp -Rp "${TEST_DIR}"/* "${DEST_DIR}"
    cp -Rp "$REPO_ROOT/test/test-utils"/* "${DEST_DIR}"
fi

export DOCKER_BUILDKIT=1

echo
echo "Creating and starting Dev Container..."
ID_LABEL="test-container=${TEMPLATE_ID}"
# NOTE: devcontainer up blocks indefinitely when starting a new container,
# but exits immediately if one is already running. See docs/devcontainer-cli.md
npx --yes @devcontainers/cli@latest up --id-label "${ID_LABEL}" --workspace-folder "${SRC_DIR}"

echo
echo "âœ“ Test environment ready!"
echo
echo "Container is running with label: ${ID_LABEL}"
echo "Test directory: ${SRC_DIR}"
echo
echo "Next steps:"
echo "  bin/run          # Open fish shell"
echo "  bin/test         # Run tests"
echo "  bin/stop         # Stop and clean up"
