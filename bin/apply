#!/usr/bin/env bash
# Apply the dotfiles devcontainer template to a project

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Default values
TEMPLATE_ID="ghcr.io/technicalpickles/dotfiles-devcontainer/dotfiles:latest"
INSTALL_ENV_VARS="${INSTALL_ENV_VARS:-}"
DOTFILES_REPO="${DOTFILES_REPO:-https://github.com/YOUR_USERNAME/dotfiles.git}"
DOTFILES_BRANCH="${DOTFILES_BRANCH:-main}"
TARGET_DIR=""

usage() {
  cat << 'EOF'
Usage: apply [OPTIONS] [TARGET_DIR]

Apply the dotfiles devcontainer template to a project directory.

This script detects whether it's running from within the dotfiles-devcontainer
repository or from elsewhere (e.g., curl | bash) and adjusts its behavior:

  - From repo: Uses local template files from src/dotfiles/
  - From elsewhere: Uses published template from GHCR

ARGUMENTS:
  TARGET_DIR         Target directory to apply template to (default: current directory)
                     Use "." for current directory

OPTIONS:
  --env KEY=VALUE    Environment variable to set before running dotfiles install.sh
                     Can be specified multiple times
  --repo URL         Dotfiles repository URL (default: YOUR_USERNAME/dotfiles)
  --branch BRANCH    Dotfiles branch (default: main)
  -h, --help         Show this help message

ENVIRONMENT VARIABLES:
  INSTALL_ENV_VARS   Environment variables in KEY1=value1,KEY2=value2 format
  DOTFILES_REPO      Same as --repo
  DOTFILES_BRANCH    Same as --branch

EXAMPLES:
  # Apply to current directory with defaults
  bin/apply .

  # Apply to a specific project directory
  bin/apply ~/projects/my-app

  # Use custom dotfiles with environment variables
  bin/apply --repo https://github.com/myuser/dotfiles.git --env DOTFILES_ROLE=devcontainer .

  # Multiple environment variables
  bin/apply --env ROLE=work --env ENV=production ~/work/project

  # Via curl (uses published template)
  curl -fsSL https://raw.githubusercontent.com/technicalpickles/dotfiles-devcontainer/main/bin/apply | bash -s -- .

WORKFLOW:
  1. Detects if running from dotfiles-devcontainer repo or standalone
  2. Installs @devcontainers/cli if not present
  3. Applies template with specified options
  4. Creates .devcontainer/ configuration in target directory

EOF
}

# Declare associative array for environment variables
declare -A ENV_VARS

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      usage
      exit 0
      ;;
    --env)
      # Parse KEY=VALUE and add to associative array
      if [[ "$2" =~ ^([^=]+)=(.*)$ ]]; then
        ENV_VARS["${BASH_REMATCH[1]}"]="${BASH_REMATCH[2]}"
      else
        echo "Error: --env requires KEY=VALUE format, got: $2" >&2
        exit 1
      fi
      shift 2
      ;;
    --repo)
      DOTFILES_REPO="$2"
      shift 2
      ;;
    --branch)
      DOTFILES_BRANCH="$2"
      shift 2
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      echo "Use --help for usage information" >&2
      exit 1
      ;;
    *)
      TARGET_DIR="$1"
      shift
      ;;
  esac
done

# Default to current directory if not specified
if [[ -z "$TARGET_DIR" ]]; then
  TARGET_DIR="."
fi

# Convert to absolute path
TARGET_DIR="$(cd "$TARGET_DIR" 2>/dev/null && pwd)" || {
  echo "Error: Target directory does not exist: $TARGET_DIR" >&2
  exit 1
}

echo "Dotfiles Dev Container Template Applier"
echo "========================================"
echo

# Detect context: are we running from the repo or standalone?
IS_IN_REPO=false
if [[ -f "$REPO_ROOT/src/dotfiles/devcontainer-template.json" ]]; then
  IS_IN_REPO=true
fi

if [[ "$IS_IN_REPO" == "true" ]]; then
  echo "üì¶ Running from dotfiles-devcontainer repository"
  echo "   Will use local template files from: src/dotfiles/"
  TEMPLATE_SOURCE="$REPO_ROOT/src/dotfiles"
else
  echo "üåê Running standalone (not in repo)"
  echo "   Will use published template: $TEMPLATE_ID"
  TEMPLATE_SOURCE="$TEMPLATE_ID"
fi

echo
echo "Configuration:"
echo "  Target directory: $TARGET_DIR"
echo "  Dotfiles repo: $DOTFILES_REPO"
echo "  Dotfiles branch: $DOTFILES_BRANCH"
if [[ ${#ENV_VARS[@]} -gt 0 ]]; then
  echo "  Environment variables:"
  for key in "${!ENV_VARS[@]}"; do
    echo "    $key=${ENV_VARS[$key]}"
  done
fi
echo

# Check if devcontainer CLI is installed
if ! command -v devcontainer &> /dev/null; then
  echo "‚ö†Ô∏è  devcontainer CLI not found"
  echo "üì¶ Installing @devcontainers/cli..."

  # Check if npx is available
  if command -v npx &> /dev/null; then
    echo "   Using npx (no installation needed)"
    DEVCONTAINER_CMD="npx --yes @devcontainers/cli"
  elif command -v npm &> /dev/null; then
    echo "   Installing globally with npm..."
    npm install -g @devcontainers/cli
    DEVCONTAINER_CMD="devcontainer"
  else
    echo "Error: Neither npx nor npm found. Please install Node.js first:" >&2
    echo "  https://nodejs.org/" >&2
    exit 1
  fi
else
  echo "‚úì devcontainer CLI found"
  DEVCONTAINER_CMD="devcontainer"
fi

echo

# Check if target directory already has devcontainer config
if [[ -d "$TARGET_DIR/.devcontainer" ]]; then
  echo "‚ö†Ô∏è  Warning: .devcontainer/ already exists in target directory"
  read -p "   Do you want to overwrite it? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
  fi
  echo "   Will overwrite existing configuration"
  echo
fi

# Apply the template
echo "üöÄ Applying template to: $TARGET_DIR"
echo

cd "$TARGET_DIR"

if [[ "$IS_IN_REPO" == "true" ]]; then
  # Running from repo - copy files manually since we can't use templates apply with local path
  echo "üìã Copying template files..."

  # Create .devcontainer directory
  mkdir -p .devcontainer

  # Copy devcontainer files
  cp "$TEMPLATE_SOURCE/.devcontainer/devcontainer.json" .devcontainer/
  cp "$TEMPLATE_SOURCE/.devcontainer/Dockerfile" .devcontainer/
  cp "$TEMPLATE_SOURCE/.devcontainer/post-create.sh" .devcontainer/

  # Replace template options with actual values
  echo "üîß Configuring template options..."

  # Build containerEnv JSON for environment variables
  if [[ ${#ENV_VARS[@]} -gt 0 ]]; then
    CONTAINER_ENV_JSON="{"
    FIRST=true
    for key in "${!ENV_VARS[@]}"; do
      if [[ "$FIRST" == "true" ]]; then
        FIRST=false
      else
        CONTAINER_ENV_JSON+=","
      fi
      # Properly escape JSON values
      VALUE=$(printf '%s' "${ENV_VARS[$key]}" | jq -R .)
      CONTAINER_ENV_JSON+="\"$key\":$VALUE"
    done
    CONTAINER_ENV_JSON+="}"
  else
    CONTAINER_ENV_JSON="{}"
  fi

  # Replace placeholders in devcontainer.json
  sed -i.bak "s|\${templateOption:installEnvVars}|$CONTAINER_ENV_JSON|g" .devcontainer/devcontainer.json
  sed -i.bak "s|\${templateOption:dotfilesRepo}|$DOTFILES_REPO|g" .devcontainer/devcontainer.json
  sed -i.bak "s|\${templateOption:dotfilesBranch}|$DOTFILES_BRANCH|g" .devcontainer/devcontainer.json
  rm .devcontainer/devcontainer.json.bak

  # Replace placeholders in Dockerfile
  sed -i.bak "s|\${templateOption:dotfilesRepo}|$DOTFILES_REPO|g" .devcontainer/Dockerfile
  sed -i.bak "s|\${templateOption:dotfilesBranch}|$DOTFILES_BRANCH|g" .devcontainer/Dockerfile
  rm .devcontainer/Dockerfile.bak

  echo "‚úì Template files copied and configured"
else
  # Running standalone - use devcontainer CLI with published template
  # Build template args for environment variables
  ENV_ARGS=""
  if [[ ${#ENV_VARS[@]} -gt 0 ]]; then
    ENV_JSON="{"
    FIRST=true
    for key in "${!ENV_VARS[@]}"; do
      if [[ "$FIRST" == "true" ]]; then
        FIRST=false
      else
        ENV_JSON+=","
      fi
      VALUE=$(printf '%s' "${ENV_VARS[$key]}" | jq -R .)
      ENV_JSON+="\"$key\":$VALUE"
    done
    ENV_JSON+="}"
    ENV_ARGS="--template-args installEnvVars='$ENV_JSON'"
  fi

  $DEVCONTAINER_CMD templates apply \
    --template-id "$TEMPLATE_ID" \
    --template-args dotfilesRepo="$DOTFILES_REPO" \
    --template-args dotfilesBranch="$DOTFILES_BRANCH" \
    $ENV_ARGS

  echo "‚úì Template applied via devcontainer CLI"
fi

echo
echo "‚úÖ Success! Dotfiles devcontainer template has been applied."
echo
echo "Next steps:"
echo "  1. Review the configuration in .devcontainer/"
echo "  2. Open this directory in VS Code"
echo "  3. Press Cmd+Shift+P and select 'Dev Containers: Reopen in Container'"
echo
echo "For better performance on macOS, consider using:"
echo "  'Dev Containers: Clone Repository in Container Volume...'"
echo "  See: https://github.com/technicalpickles/dotfiles-devcontainer#macos-performance-optimization"
echo
