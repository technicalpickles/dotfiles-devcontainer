#!/usr/bin/env bash
# Stop and clean up the dotfiles template container

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

TEMPLATE_ID="dotfiles"
CLEAN_BUILD_DIR=false

usage() {
  cat << EOF
Usage: $(basename "$0") [OPTIONS]

Stop and clean up the dotfiles template container.

OPTIONS:
  -c, --clean    Also remove the build directory (tmp/dotfiles)
  -h, --help     Show this help message

EXAMPLES:
  # Stop dotfiles container
  $(basename "$0")

  # Stop and clean up build directory
  $(basename "$0") --clean

WORKFLOW:
  After stopping, you can set up a new test environment with:
    bin/setup-test
    bin/run
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -c | --clean)
      CLEAN_BUILD_DIR=true
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    -*)
      echo "Error: Unknown option $1" >&2
      usage
      exit 1
      ;;
    *)
      echo "Error: Unexpected argument $1" >&2
      usage
      exit 1
      ;;
  esac
done

SRC_DIR="$REPO_ROOT/tmp/${TEMPLATE_ID}"
ID_LABEL="test-container=${TEMPLATE_ID}"

echo "Stopping template: ${TEMPLATE_ID}"
echo "Build directory: ${SRC_DIR}"
echo

# Find the container by label
CONTAINER_ID=$(docker ps -a --filter "label=${ID_LABEL}" --format "{{.ID}}" | head -1)

if [[ -z "$CONTAINER_ID" ]]; then
  echo "No container found for template: ${TEMPLATE_ID}"
else
  CONTAINER_NAME=$(docker inspect --format='{{.Name}}' "$CONTAINER_ID" | sed 's/^\///')
  echo "Found container: $CONTAINER_NAME ($CONTAINER_ID)"
  echo

  # Stop and remove the container
  echo "Stopping and removing container..."
  docker rm -f "$CONTAINER_ID"
  echo "âœ“ Container removed"
fi

# Clean up build directory if requested
if [[ "$CLEAN_BUILD_DIR" == "true" ]]; then
  if [[ -d "${SRC_DIR}" ]]; then
    echo
    echo "Removing build directory: ${SRC_DIR}"
    rm -rf "${SRC_DIR}"
    echo "âœ“ Build directory removed"
  fi
fi

echo
echo "Done! ðŸ›‘"
echo

if [[ "$CLEAN_BUILD_DIR" == "false" && -d "${SRC_DIR}" ]]; then
  echo "Build directory still exists at: ${SRC_DIR}"
  echo "To remove it: $(basename "$0") --clean"
  echo
fi

echo "To set up a new test environment:"
echo "  bin/setup-test"
echo "  bin/run"
