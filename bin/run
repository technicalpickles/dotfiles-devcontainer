#!/usr/bin/env bash
# Run commands in the dotfiles template container

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

usage() {
  cat << EOF
Usage: $(basename "$0") [COMMAND]

Execute commands in the dotfiles template container.

ARGUMENTS:
  COMMAND        Command to execute (default: open fish shell)

OPTIONS:
  -h, --help     Show this help message

EXAMPLES:
  # Open interactive fish shell
  $(basename "$0")

  # Run a specific command
  $(basename "$0") ls -la
  $(basename "$0") "echo test"

WORKFLOW:
  The container must already be running (use 'bin/setup-test' first).
  This executes commands inside the test container.
EOF
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

TEMPLATE_ID="dotfiles"
SRC_DIR="$REPO_ROOT/tmp/${TEMPLATE_ID}"
ID_LABEL="test-container=${TEMPLATE_ID}"

# Check if build is needed
NEEDS_BUILD=false

if [[ ! -d "${SRC_DIR}" ]]; then
  echo "Build directory not found. Building container..."
  NEEDS_BUILD=true
else
  # Check if container is running
  CONTAINER_ID=$(docker ps --filter "label=${ID_LABEL}" --format "{{.ID}}" | head -1)
  if [[ -z "$CONTAINER_ID" ]]; then
    echo "Container is not running. Building container..."
    NEEDS_BUILD=true
  fi
fi

if [[ "$NEEDS_BUILD" == "true" ]]; then
  "$SCRIPT_DIR/setup-test"
  echo
fi

echo "Running in template: ${TEMPLATE_ID}"
echo "Build directory: ${SRC_DIR}"
echo

# If no command specified, open interactive fish shell
if [[ $# -eq 0 ]]; then
  echo "Opening fish shell..."
  npx --yes @devcontainers/cli@latest exec \
    --workspace-folder "${SRC_DIR}" \
    --id-label "${ID_LABEL}" \
    fish
else
  echo "Executing: $*"
  npx --yes @devcontainers/cli@latest exec \
    --workspace-folder "${SRC_DIR}" \
    --id-label "${ID_LABEL}" \
    "$@"
fi
