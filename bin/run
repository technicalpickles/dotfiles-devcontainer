#!/usr/bin/env bash
# Run tests or commands in the template container

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

TEMPLATE_ID="${1:-pickles}"
shift || true

usage() {
  cat << EOF
Usage: $(basename "$0") [TEMPLATE_ID] [COMMAND]

Execute commands or run tests in the template container.

ARGUMENTS:
  TEMPLATE_ID    Template to run (default: pickles)
  COMMAND        Command to execute (default: run tests)

OPTIONS:
  -h, --help     Show this help message

EXAMPLES:
  # Run tests for pickles template
  $(basename "$0")
  $(basename "$0") pickles

  # Open a fish shell
  $(basename "$0") pickles fish

  # Run a custom command
  $(basename "$0") pickles "ls -la"

WORKFLOW:
  The container must already be running (use 'bin/build' first).
  This executes commands inside the built template container.
EOF
}

if [[ "${TEMPLATE_ID}" == "-h" || "${TEMPLATE_ID}" == "--help" ]]; then
  usage
  exit 0
fi

SRC_DIR="$REPO_ROOT/tmp/${TEMPLATE_ID}"
ID_LABEL="test-container=${TEMPLATE_ID}"

echo "Running in template: ${TEMPLATE_ID}"
echo "Build directory: ${SRC_DIR}"
echo

# If no command specified, run tests
if [[ $# -eq 0 ]]; then
  echo "Running tests..."
  npx --yes @devcontainers/cli@latest exec \
    --workspace-folder "${SRC_DIR}" \
    --id-label "${ID_LABEL}" \
    /bin/sh -c 'set -e && if [ -f "test-project/test.sh" ]; then cd test-project && if [ "$(id -u)" = "0" ]; then chmod +x test.sh; else sudo chmod +x test.sh; fi && ./test.sh; else echo "No tests found"; ls -la; fi'
else
  echo "Executing: $*"
  npx --yes @devcontainers/cli@latest exec \
    --workspace-folder "${SRC_DIR}" \
    --id-label "${ID_LABEL}" \
    "$@"
fi
