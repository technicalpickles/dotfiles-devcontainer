#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

IMAGE_TAG="${IMAGE_TAG:-ghcr.io/technicalpickles/dotfiles-devcontainer/base:latest}"
DOTFILES_REPO="${DOTFILES_REPO:-}"
DOTFILES_BRANCH="${DOTFILES_BRANCH:-main}"

# shellcheck source=../test/test-utils/dotfiles_fixture.bash
source "${REPO_ROOT}/test/test-utils/dotfiles_fixture.bash"
trap cleanup_dotfiles_fixtures EXIT

usage() {
  cat <<EOF
Usage: $(basename "$0") [--tag <image-tag>] [--repo <dotfiles-repo>] [--branch <dotfiles-branch>]

Run base image tests (goss + functional smoke).

Options:
  --tag <image>     Base image tag to test (default: ${IMAGE_TAG})
  --repo <url>      Dotfiles repo for functional smoke (default: fixture in test/fixtures/simple-dotfiles)
  --branch <name>   Dotfiles branch (default: ${DOTFILES_BRANCH})
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --tag)
      IMAGE_TAG="$2"
      shift 2
      ;;
    --repo)
      DOTFILES_REPO="$2"
      shift 2
      ;;
    --branch)
      DOTFILES_BRANCH="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ -z "${DOTFILES_REPO}" ]]; then
  DOTFILES_REPO="file://$(create_dotfiles_fixture_repo)"
fi

GOSS_FILE="${REPO_ROOT}/docker/goss.yaml"

if [[ ! -f "${GOSS_FILE}" ]]; then
  echo "Missing goss file: ${GOSS_FILE}" >&2
  exit 1
fi

# Always initialize to keep set -u happy when PLATFORM is unset
PLATFORM_FLAG=()
if [[ -n "${PLATFORM:-}" ]]; then
  PLATFORM_FLAG=(--platform "$PLATFORM")
fi

REPO_MOUNT=()
CONTAINER_REPO_URL="${DOTFILES_REPO}"
if [[ "${DOTFILES_REPO}" =~ ^file:// ]]; then
  repo_path="${DOTFILES_REPO#file://}"
  mount_target="/tmp/dotfiles-fixture"
  REPO_MOUNT=(-v "${repo_path}:${mount_target}:ro")
  CONTAINER_REPO_URL="file://${mount_target}"
fi
echo "Running goss checks..."
docker run --rm \
  ${PLATFORM_FLAG+"${PLATFORM_FLAG[@]}"} \
  -v "${GOSS_FILE}:/tmp/goss.yaml:ro" \
  "${IMAGE_TAG}" \
  bash -lc 'goss -g /tmp/goss.yaml validate'

echo "Running functional smoke..."
docker run --rm \
  ${PLATFORM_FLAG+"${PLATFORM_FLAG[@]}"} \
  ${REPO_MOUNT+"${REPO_MOUNT[@]}"} \
  --user vscode \
  -w /home/vscode \
  "${IMAGE_TAG}" \
  bash -lc "set -euo pipefail; \
    git config --global user.email test@example.com; \
    git config --global user.name Test; \
    setup-dotfiles --repo \"${CONTAINER_REPO_URL}\" --branch \"${DOTFILES_BRANCH}\" --env DOCKER_BUILD=true --env DOTPICKLES_ROLE=noop; \
    setup-dotfiles --repo \"${CONTAINER_REPO_URL}\" --branch \"${DOTFILES_BRANCH}\" --env DOCKER_BUILD=true --env DOTPICKLES_ROLE=noop; \
    test -d /home/vscode/.dotfiles/.git; \
    if [[ \"${DOTFILES_REPO}\" == file://* ]]; then \
      test -f /home/vscode/.dotfiles/.fixture-installed; \
      test -f /home/vscode/.config/fish/config.fish; \
      test -f /home/vscode/.config/starship.toml; \
    fi; \
    fish --version; gh --version; aws --version; op --version; mise --version; starship --version"

echo "âœ“ Base image tests passed"
