name: "Publish DinD Feature"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Feature version to publish (defaults to devcontainer-feature.json)"
        required: false
        type: string
      dry-run:
        description: "Run publish without pushing"
        required: false
        type: boolean
        default: false

env:
  BASE_IMAGE: ghcr.io/technicalpickles/dotfiles-devcontainer/base@sha256:3195dd842e35bc1318b06c86c849e464b23fbc2082fc5de64f4b7bcaa789a63b
  FEATURE_NAMESPACE: technicalpickles/devcontainer-features
  FEATURE_PATH: src/dotfiles/.devcontainer/features/dind
  PUBLISH_RESULT: tmp/dind-feature-publish.json

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install devcontainer CLI and bats
        run: npm install -g @devcontainers/cli bats-core

      - name: Pull pinned base image
        run: docker pull "${BASE_IMAGE}"

      - name: Run base image smoke (Goss + setup-dotfiles)
        run: bin/test-base --tag "${BASE_IMAGE}"

      - name: Run template tests (bats)
        run: bats test/apply.bats

      - name: Publish DinD feature
        env:
          REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REGISTRY_USERNAME: ${{ github.actor }}
          VERSION_OVERRIDE: ${{ inputs.version }}
          DRY_RUN: ${{ inputs.dry-run }}
          RESULT_PATH: ${{ env.PUBLISH_RESULT }}
          PACKAGE_OUT: tmp/dind-feature-package
        run: bin/publish-dind-feature

      - name: Validate publish summary and wiring
        env:
          REQUIRE_DOCKER: true
          PUBLISH_RESULT_PATH: ${{ env.PUBLISH_RESULT }}
        run: |
          FEATURE_TARBALL="$(find tmp/dind-feature-package -maxdepth 1 -name '*.tgz' | head -n 1 || true)"
          if [[ -z "$FEATURE_TARBALL" ]]; then
            echo "Packaged feature tarball missing under tmp/dind-feature-package" >&2
            exit 1
          fi
          FEATURE_VERSION="$(node -e "console.log(require('./src/dotfiles/.devcontainer/features/dind/devcontainer-feature.json').version)")"
          FEATURE_TARBALL="$FEATURE_TARBALL" FEATURE_VERSION="$FEATURE_VERSION" test/features/dind/test.sh

      - name: Publish summary
        if: always()
        run: |
          {
            echo "## DinD feature publish"
            if [[ -f "${PUBLISH_RESULT}" ]]; then
              echo
              echo '```json'
              cat "${PUBLISH_RESULT}"
              echo '```'
            else
              echo "- Publish summary not found at ${PUBLISH_RESULT}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
