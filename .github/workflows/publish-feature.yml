name: "Publish Feature"

on:
  workflow_dispatch:
    inputs:
      feature:
        description: "Feature name to publish (e.g., dind, aws-cli)"
        required: true
        type: string
      version:
        description: "Feature version to publish (defaults to devcontainer-feature.json)"
        required: false
        type: string
      dry-run:
        description: "Run publish without pushing"
        required: false
        type: boolean
        default: false

env:
  BASE_IMAGE: ghcr.io/technicalpickles/dotfiles-devcontainer/base:latest
  FEATURE_NAMESPACE: technicalpickles/devcontainer-features

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Install devcontainer CLI, bats, and ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep
          npm install -g @devcontainers/cli bats

      - name: Pull pinned base image
        run: docker pull "${BASE_IMAGE}"

      - name: Run base image smoke (Goss + setup-dotfiles)
        run: bin/test-base --tag "${BASE_IMAGE}"

      - name: Run template tests (bats)
        run: bats test/apply.bats

      - name: Publish feature
        env:
          REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REGISTRY_USERNAME: ${{ github.actor }}
          VERSION_OVERRIDE: ${{ inputs.version }}
          DRY_RUN: ${{ inputs.dry-run }}
          RESULT_PATH: tmp/${{ inputs.feature }}-feature-publish.json
          PACKAGE_OUT: tmp/${{ inputs.feature }}-feature-package
        run: bin/publish-feature ${{ inputs.feature }}

      - name: Publish summary
        if: always()
        env:
          FEATURE: ${{ inputs.feature }}
        run: |
          RESULT_FILE="tmp/${FEATURE}-feature-publish.json"
          {
            echo "## ${FEATURE} feature publish"
            if [[ -f "$RESULT_FILE" ]]; then
              echo
              echo '```json'
              cat "$RESULT_FILE"
              echo '```'
            else
              echo "- Publish summary not found at ${RESULT_FILE}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
